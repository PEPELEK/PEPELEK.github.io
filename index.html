<?php
// db.php - veritabanı bağlantısı
$servername = "localhost";
$username = "root";
$password = "";
$dbname = "oyunsitesi";

$conn = new mysqli($servername, $username, $password, $dbname);
if ($conn->connect_error) { die("Connection failed: " . $conn->connect_error); }
session_start();
?>

<?php
// index.php - giriş yapmış kullanıcıları görebileceğin ana sayfa
include 'db.php';

// Kullanıcı çıkış yaparsa session temizle
if(isset($_GET['logout'])){
    session_destroy();
    header("Location: login.php");
    exit();
}

// Kullanıcı giriş yapmışsa bilgileri al
if(isset($_SESSION['user_id'])){
    $userid = $_SESSION['user_id'];
    $sql = "SELECT username, balance FROM users WHERE id='$userid'";
    $result = $conn->query($sql);
    $user = $result->fetch_assoc();
}
?>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Oyun Sitesi</title>
<style>
body{ font-family: Arial; background:#f4f4f4; margin:0; padding:0;}
header{ background:#222; color:white; padding:10px; display:flex; justify-content:space-between;}
button{padding:5px 10px; margin-left:5px; cursor:pointer;}
#market, #admin-panel{margin:20px; padding:20px; background:white; border-radius:5px;}
input{padding:5px; margin:5px 0;}
</style>
</head>
<body>

<header>
    <div>
        <?php if(isset($user)): ?>
            Hoşgeldin, <strong><?php echo htmlspecialchars($user['username']); ?></strong>
        <?php else: ?>
            Ziyaretçi
        <?php endif; ?>
    </div>
    <div>
        <?php if(isset($user)): ?>
            <button onclick="alert('Mevcut bakiye: <?php echo $user['balance']; ?>')">Bakiye</button>
            <button onclick="window.location='?logout=true'">Çıkış Yap</button>
        <?php else: ?>
            <a href="login.php"><button>Giriş Yap</button></a>
            <a href="register.php"><button>Kayıt Ol</button></a>
        <?php endif; ?>
        <button onclick="copyText()">Kopyala</button>
    </div>
</header>

<div id="market">
    <h2>Market</h2>
    <?php
    $products = $conn->query("SELECT * FROM products");
    while($p = $products->fetch_assoc()){
        echo "<div>";
        echo "Ürün: ".htmlspecialchars($p['name'])." - Bakiye: ".$p['price'];
        echo " <button onclick=\"buyProduct(".$p['id'].")\">Satın Al</button>";
        echo "</div>";
    }
    ?>
</div>

<?php if(isset($user) && $user['username']=="admin"): ?>
<div id="admin-panel">
    <h2>Admin Paneli</h2>
    <h3>Bakiye Yükle</h3>
    <form method="post">
        Kullanıcı Adı: <input type="text" name="player"><br>
        Yüklenecek Bakiye: <input type="number" name="amount"><br>
        <button type="submit" name="load_balance">Yükle</button>
    </form>

    <h3>Market Ürün Ekle</h3>
    <form method="post">
        Ürün Adı: <input type="text" name="item_name"><br>
        Fiyat: <input type="number" name="item_price"><br>
        <button type="submit" name="add_product">Ekle</button>
    </form>
</div>
<?php endif; ?>

<script>
function copyText(){
    navigator.clipboard.writeText("eldryasmp.aternos.me");
    alert("Kopyalandı!");
}

function buyProduct(id){
    fetch('buy.php?id='+id)
    .then(res=>res.text())
    .then(alert)
    .then(()=>location.reload());
}
</script>

</body>
</html>

<?php
// Admin işlemleri
if(isset($_POST['load_balance'])){
    $player = $_POST['player'];
    $amount = (int)$_POST['amount'];
    $conn->query("UPDATE users SET balance=balance+$amount WHERE username='$player'");
    echo "<script>alert('Bakiye yüklendi!');</script>";
}

if(isset($_POST['add_product'])){
    $name = $_POST['item_name'];
    $price = (int)$_POST['item_price'];
    $conn->query("INSERT INTO products(name,price) VALUES('$name',$price)");
    echo "<script>alert('Ürün eklendi!');</script>";
}
?>

